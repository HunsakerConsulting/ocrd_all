version: 2.1
jobs:
  build:
    docker:
      - image: cimg/base:stable-18.04
    steps:
      - checkout
      - setup_remote_docker      # https://circleci.com/docs/2.0/building-docker-images/
      - run: make docker-maximum-cuda
      - when:
          # takes too long for 1h1m CircleCI timeout overall
          condition: false
          steps:
            - run:
                name: persist image
                command: |
                  sudo apt install pigz
                  docker image save ocrd/all:maximum-cuda | pigz --fast > ocrd-all-maximum.tar.gz
                no_output_timeout: 30m
            # can be downloaded from CircleCI.com and imported via "docker image load"
            - store_artifacts:
                path: ocrd-all-maximum.tar.gz
                destination: artifacts
  deploy:
    docker:
      - image: cimg/base:stable-18.04
    environment:
      GIT_DEPTH: "--depth 1"
    parameters:
      variant:
        type:
          string
    steps:
      - checkout
      - setup_remote_docker      # https://circleci.com/docs/2.0/building-docker-images/
      - run:
          name: Build Docker image
          command: make docker-<< parameters.variant >>-git DOCKER_PARALLEL=-j2
      - run:
          name: Alias Docker images
          command: docker tag ocrd/all:test-<< parameters.variant >>-git ocrd/all:test-<< parameters.variant >>
      - run:
          name: Login to Docker Hub
          command: echo "$DOCKERHUB_PASS" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
      - run:
          name: Push images to Docker Hub
          no_output_timeout: 2.5h
          command: |
            docker push ocrd/all:test-<< parameters.variant >>
            docker push ocrd/all:test-<< parameters.variant >>-git
workflows:
  version: 2
  build-master:
    jobs:
      - deploy:
          matrix:
            parameters:
              # variant: [minimum]
              variant: [minimum, medium, maximum, maximum-cuda]
          filters:
            branches:
              only: dockertest
