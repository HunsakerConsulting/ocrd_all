version: 2.1
jobs:
  build:
    docker:
      - image: circleci/buildpack-deps:stretch
    steps:
      - checkout
      - setup_remote_docker      # https://circleci.com/docs/2.0/building-docker-images/
      - run: make docker-maximum DOCKER_PARALLEL=-j3
      - run: docker image save ocrd/all:maximum > ocrd-all-maximum.tar
      # can be downloaded from CircleCI.com and imported via "docker image load"
      - store_artifacts:
          path: ocrd-all-maximum.tar
          destination: artifacts
  deploy:
    docker:
      - image: circleci/buildpack-deps:stretch
    environment:
      GIT_DEPTH: "--depth 1"
    parameters:
      variant:
        type:
          string
    steps:
      - checkout
      - setup_remote_docker      # https://circleci.com/docs/2.0/building-docker-images/
      - run:
          name: Build Docker image
          command: make docker-<< parameters.variant >>-git DOCKER_PARALLEL=-j3
      - run:
          name: Alias Docker images
          command: docker tag ocrd/all:<< parameters.variant >>-git ocrd/all:<< parameters.variant >>
      - run:
          name: Login to Docker Hub
          command: echo "$DOCKERHUB_PASS" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
      - run:
          name: Push images to Docker Hub
          no_output_timeout: 2.5h
          command: |
            docker push ocrd/all:<< parameters.variant >>
            docker push ocrd/all:<< parameters.variant >>-git
      - when:
          condition:
            equal: [ maximum, << parameters.variant >> ]
          steps:
            - run:
                name: Create a date-versioned mirror of ocrd/all:maximum
                command: bash release.sh release-dockerhub
            - run:
                name: Update badge
                command: curl -X POST "$MICROBADGER_WEBHOOK" || true
workflows:
  version: 2
  build-master:
    jobs:
      - deploy:
          matrix:
            parameters:
              variant: [minimum, medium, maximum, maximum-cuda]
          filters:
            branches:
              only: master
  build-pull-request:
    jobs:
      - build:
          filters:
            branches:
              ignore: master
